"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const Errors_1 = require("../../Errors");
const LOG_PREFIX = '[Resolve Container Id]';
const DEFAULT_TIMEOUT = 30;
exports.resolveContainerId = async ({ runner, runner: { logger, dockerEventStream$ } }) => rxjs_1.race(dockerEventStream$.pipe(operators_1.first(event => event.action === 'start'), operators_1.tap(({ id: containerId }) => {
    logger.info(`${LOG_PREFIX} Success (${containerId})`, { success: true });
    runner.containerId = containerId;
})), rxjs_1.interval(1000).pipe(operators_1.tap(i => {
    runner.logger.info(`Still waiting for start event... Timeout in ${DEFAULT_TIMEOUT - i}s`);
}), operators_1.skipWhile(i => i < DEFAULT_TIMEOUT), operators_1.map(() => {
    throw new Errors_1.DockestError('Timed out', { runner });
})))
    .pipe(operators_1.take(1))
    .toPromise();
//# sourceMappingURL=resolveContainerId.js.map